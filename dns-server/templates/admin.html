{% extends "base.html" %}

{% block title %}AdministraÃ§Ã£o - Painel DNS{% endblock %}

{% block content %}
<div class="container">
  <div class="topbar">
    <h2>âš™ï¸ AdministraÃ§Ã£o</h2>
    <div class="topbar-actions">
      <a href="{{ url_for('index') }}" class="btn-secondary">
        <i class="icon">â†</i> Voltar ao Painel
      </a>
    </div>
  </div>

  <!-- AÃ§Ãµes rÃ¡pidas -->
  <div class="quick-actions">
    <a href="{{ url_for('dns_server_settings') }}" class="action-card">
      <div class="action-icon">ğŸŒ</div>
      <div class="action-title">ConfiguraÃ§Ãµes DNS</div>
      <div class="action-desc">Nome do servidor e configuraÃ§Ãµes PTR</div>
    </a>

    <a href="{{ url_for('ssl_ca_settings') }}" class="action-card">
      <div class="action-icon">ğŸ›ï¸</div>
      <div class="action-title">Autoridade Certificadora</div>
      <div class="action-desc">Configurar certificado SSL da empresa</div>
    </a>

    <a href="#" onclick="if(confirm('âš ï¸ ATENÃ‡ÃƒO: RESET TOTAL DO SISTEMA âš ï¸\n\nEsta aÃ§Ã£o irÃ¡:\nâ€¢ Remover TODOS os registros DNS\nâ€¢ Resetar senha do admin para padrÃ£o\nâ€¢ Remover todos os certificados SSL\nâ€¢ Limpar todas as configuraÃ§Ãµes customizadas\nâ€¢ Restaurar o sistema ao estado de fÃ¡brica\n\nâŒ Esta aÃ§Ã£o Ã© IRREVERSÃVEL!\n\nDeseja continuar?')) { const confirmText = prompt('Para confirmar o RESET TOTAL, digite exatamente: RESET'); if(confirmText === 'RESET') { document.getElementById('restore-form').submit(); } else { alert('ConfirmaÃ§Ã£o incorreta. Reset cancelado.'); } }" class="action-card">
      <div class="action-icon">ğŸ”„</div>
      <div class="action-title">Reset Total</div>
      <div class="action-desc">Restaura o sistema ao estado padrÃ£o de fÃ¡brica</div>
    </a>

    <a href="#" onclick="if(confirm('Isso removerÃ¡ certificados SSL e configuraÃ§Ãµes Nginx Ã³rfÃ£os. Continuar?')) { document.getElementById('cleanup-form').submit(); }" class="action-card">
      <div class="action-icon">ğŸ§¹</div>
      <div class="action-title">Limpar Arquivos Ã“rfÃ£os</div>
      <div class="action-desc">Remove certificados e configs nÃ£o utilizados</div>
    </a>

    <form id="restore-form" method="post" action="/full-restore" style="display: none;"></form>
    <form id="cleanup-form" method="post" action="/cleanup-orphaned" style="display: none;"></form>
  </div>

  <!-- Troca de senha do admin -->
  <div class="card">
    <h3>ğŸ”’ Alterar senha do administrador</h3>
    <form method="post" action="/change_password">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <div class="form-group">
          <label for="current_password">Senha atual:</label>
          <input type="password" id="current_password" name="current_password" placeholder="Senha atual" required>
        </div>
        <div class="form-group">
          <label for="new_password">Nova senha:</label>
          <input type="password" id="new_password" name="new_password" placeholder="Nova senha" required minlength="6">
        </div>
        <div class="form-group">
          <label for="confirm_password">Confirmar nova senha:</label>
          <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirmar nova senha" required minlength="6">
        </div>
      </div>
      <button type="submit" class="btn-success">Alterar senha</button>
    </form>
  </div>

  <div class="card">
    <h3>ğŸ‘¥ Criar novo usuÃ¡rio</h3>
    <form method="post">
      <input type="hidden" name="action" value="add">
      <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
        <div style="flex: 1; min-width: 150px;">
          <label for="username" style="display: block; margin-bottom: 5px; font-weight: 500;">UsuÃ¡rio:</label>
          <input type="text" id="username" name="username" placeholder="Nome de usuÃ¡rio" required
                 pattern="^[a-zA-Z0-9_-]{3,20}$">
        </div>
        <div style="flex: 1; min-width: 150px;">
          <label for="password" style="display: block; margin-bottom: 5px; font-weight: 500;">Senha:</label>
          <input type="password" id="password" name="password" placeholder="Senha" required minlength="6">
        </div>
        <div>
          <button type="submit" class="btn-primary">Adicionar UsuÃ¡rio</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <h3>ğŸ“‹ UsuÃ¡rios existentes</h3>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>UsuÃ¡rio</th>
            <th>Admin</th>
            <th style="width: 300px;">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody>
          {% for user, info in users.items() %}
          <tr>
            <td><strong>{{ user }}</strong></td>
            <td>{{ "âœ…" if info.is_admin else "âŒ" }}</td>
            <td class="actions">
              {% if user != "admin" %}
              <form method="post" style="display:inline;">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="username" value="{{ user }}">
                <button type="submit" class="btn-danger btn-sm"
                        onclick="return confirm('Tem certeza que deseja excluir o usuÃ¡rio {{ user }}?')">
                  Excluir
                </button>
              </form>
              <form method="post" style="display:inline;">
                <input type="hidden" name="action" value="reset">
                <input type="hidden" name="username" value="{{ user }}">
                <div style="display: inline-flex; gap: 5px;">
                  <input type="password" name="new_password" placeholder="Nova senha" required minlength="6"
                         style="padding: 4px 8px; font-size: 0.8rem; width: 120px;">
                  <button type="submit" class="btn-success btn-sm">Redefinir</button>
                </div>
              </form>
              {% else %}
              <span class="text-muted">AÃ§Ãµes nÃ£o disponÃ­veis</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Mostrar toast (funÃ§Ã£o reutilizada) - CORRIGIDA
function showToast(message, type = "success") {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.textContent = message;

  switch(type) {
    case 'success': toast.style.background = 'var(--success)'; break;
    case 'danger': toast.style.background = 'var(--danger)'; break;
    case 'warning': toast.style.background = 'var(--warning)'; break;
    default: toast.style.background = 'var(--gray)';
  }

  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (container.contains(toast)) {
        container.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Flash messages do Flask - CORRIGIDO
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      showToast({{ msg|tojson }}, {{ category|tojson }});
    {% endfor %}
  {% endif %}
{% endwith %}

// ValidaÃ§Ã£o de formulÃ¡rios admin - CORRIGIDO
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
      const password = this.querySelector('input[type="password"]');
      if (password && password.value.length < 6) {
        e.preventDefault();
        showToast('A senha deve ter pelo menos 6 caracteres.', 'warning');
        return;
      }

      const username = this.querySelector('input[name="username"]');
      if (username && !/^[a-zA-Z0-9_-]{3,20}$/.test(username.value)) {
        e.preventDefault();
        showToast('UsuÃ¡rio deve ter 3-20 caracteres (apenas letras, nÃºmeros, _ e -).', 'warning');
        return;
      }
    });
  });
});
</script>
{% endblock %}