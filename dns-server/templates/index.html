{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="topbar">
    <h2>‚ö° Servidor DNS Local (Apenas Rede Interna)</h2>
    <div class="user-menu">
      <div class="user-icon" onclick="toggleMenu()">üë§</div>
      <div class="menu-dropdown" id="menuDropdown">
        {% if session.get('is_admin') %}
          <a href="/admin" class="menu-item">‚öôÔ∏è Configura√ß√µes</a>
        {% endif %}
        <form method="POST" action="/logout" style="margin:0;">
          <button type="submit" class="menu-item">üö™ Logout</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Form adicionar DNS COM SSL -->
  <div class="card">
    <form method="post" action="/add" id="add-form">
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label for="ip" style="display: block; margin-bottom: 5px; font-weight: 500;">IP interno:</label>
          <input type="text" id="ip" name="ip" placeholder="ex: 192.168.5.10" required
                 pattern="^(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3})$">
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label for="domain" style="display: block; margin-bottom: 5px; font-weight: 500;">Dom√≠nio:</label>
          <input type="text" id="domain" name="domain" placeholder="ex: app.local" required
                 pattern="^[a-zA-Z0-9]([a-zA-Z0-9_.-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9_.-]{0,61}[a-zA-Z0-9])?)*$">
        </div>
        <div style="align-self: flex-end;">
          <button type="submit" class="btn-primary">‚ûï Adicionar</button>
        </div>
      </div>
      
      <!-- Configura√ß√µes SSL -->
      <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
          <div>
            <label class="checkbox-label">
              <input type="checkbox" name="ssl_enabled" id="ssl_enabled">
              <span class="checkmark"></span>
              Habilitar SSL/HTTPS
            </label>
          </div>
          <div>
            <label for="http_port" style="font-size: 12px; font-weight: 500;">Porta HTTP:</label>
            <input type="number" id="http_port" name="http_port" value="80" min="1" max="65535" style="width: 80px; padding: 4px;">
          </div>
          <div>
            <label for="ssl_port" style="font-size: 12px; font-weight: 500;">Porta HTTPS:</label>
            <input type="number" id="ssl_port" name="ssl_port" value="443" min="1" max="65535" style="width: 80px; padding: 4px;">
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Registros DNS -->
  <div class="card">
    <h3>Registros Atuais ({{ records|length }})</h3>
    {% if records|length == 0 %}
      <p class="text-muted">Nenhum registro ainda. Adicione acima!</p>
    {% else %}
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Dom√≠nio</th>
              <th>IP</th>
              <th>SSL</th>
              <th style="width: 250px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for domain, ip in records %}
            <tr data-domain="{{ domain }}" data-ip="{{ ip }}">
              <td><strong class="domain-link" onclick="sortByDomain('{{ domain.split('_')[0] }}')" style="cursor:pointer;">{{ domain }}</strong></td>
              <td><code class="code ip-link" data-ip="{{ ip }}" onclick="sortByIP('{{ ip }}')" style="cursor:pointer;">{{ ip }}</code></td>
              <td>
                {% set ssl_info = ssl_status.get(domain, {'ssl_enabled': False}) %}
                {% if ssl_info.ssl_enabled %}
                  <span style="color: #10b981; font-weight: bold;">üîí HTTPS</span>
                {% else %}
                  <span style="color: #6b7280;">üîì HTTP</span>
                {% endif %}
              </td>
              <td class="actions">
                <button type="button" class="btn-success btn-sm btn-copy" data-ip="{{ ip }}" onclick="event.stopPropagation();">üìã Copiar IP</button>
                
                <!-- Bot√£o SSL -->
                <a href="/ssl/{{ domain }}">
                  <button class="btn-info btn-sm" type="button" onclick="event.stopPropagation();">
                    {{ 'üîß SSL' if ssl_info.ssl_enabled else '‚öôÔ∏è SSL' }}
                  </button>
                </a>
                
                <a href="{{ url_for('edit', domain=domain) }}">
                  <button class="btn-warning btn-sm" type="button" onclick="event.stopPropagation();">‚úèÔ∏è Editar</button>
                </a>
                <form method="post" action="/delete/{{ domain }}" style="display:inline;"
                  onsubmit="return confirm('‚ö†Ô∏è Tem certeza que quer remover\n{{ domain }} ‚Üí {{ ip }} ?');">
                  <button type="submit" class="btn-danger btn-sm" onclick="event.stopPropagation();">üóëÔ∏è Remover</button>
                </form>
              </td>
            </tr>

            {% if edit_domain == domain %}
            <tr>
              <td colspan="4">
                <div class="card" style="border: 2px solid #f59e0b; margin-top:10px;">
                  <h4>‚úèÔ∏è Editando: {{ edit_domain }}</h4>
                  <form method="post" action="{{ url_for('update', old_domain=edit_domain) }}">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                      <div style="flex: 1; min-width: 200px;">
                        <label for="new_domain" style="display: block; margin-bottom: 5px; font-weight: 500;">Dom√≠nio:</label>
                        <input type="text" id="new_domain" name="new_domain" value="{{ edit_domain }}"
                               placeholder="Dom√≠nio (deixe vazio para manter o mesmo)"
                               pattern="^[a-zA-Z0-9]([a-zA-Z0-9_.-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9_.-]{0,61}[a-zA-Z0-9])?)*$">
                      </div>
                      <div style="flex: 1; min-width: 200px;">
                        <label for="new_ip" style="display: block; margin-bottom: 5px; font-weight: 500;">IP interno:</label>
                        <input type="text" id="new_ip" name="new_ip" value="{{ current_ip }}" required
                               placeholder="Novo IP interno"
                               pattern="^(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3})$">
                      </div>
                      <div>
                        <button type="submit" class="btn-primary">üíæ Salvar</button>
                        <a href="/"><button type="button" class="btn-secondary">‚ùå Cancelar</button></a>
                      </div>
                    </div>
                  </form>
                </div>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Mostrar toast
function showToast(message, type = "success") {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.textContent = message;

  switch(type) {
    case 'success': toast.style.background = 'var(--success)'; break;
    case 'danger': toast.style.background = 'var(--danger)'; break;
    case 'warning': toast.style.background = 'var(--warning)'; break;
    default: toast.style.background = 'var(--gray)';
  }

  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (container.contains(toast)) {
        container.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Flash messages do Flask
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      showToast({{ msg|tojson }}, {{ category|tojson }});
    {% endfor %}
  {% endif %}
{% endwith %}

// Copiar IP
function setupCopyButtons() {
  document.querySelectorAll('.btn-copy').forEach(btn => {
    btn.replaceWith(btn.cloneNode(true));
  });

  document.querySelectorAll('.btn-copy').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const text = btn.getAttribute('data-ip');
      if (!text) return;

      try {
        await navigator.clipboard.writeText(text);
        showToast('üìã IP copiado: ' + text, 'success');
      } catch (err) {
        try {
          const temp = document.createElement('textarea');
          temp.value = text;
          temp.style.position = 'fixed';
          temp.style.opacity = '0';
          document.body.appendChild(temp);
          temp.select();
          const successful = document.execCommand('copy');
          document.body.removeChild(temp);
          
          if (successful) {
            showToast('üìã IP copiado: ' + text, 'success');
          } else {
            showToast('‚ùå Falha ao copiar IP', 'danger');
          }
        } catch (fallbackErr) {
          showToast('‚ùå Erro ao copiar IP', 'danger');
        }
      }
    });
  });
}

// Menu usu√°rio
function toggleMenu() {
  const menu = document.getElementById('menuDropdown');
  if (menu) {
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }
}

// Fechar menu ao clicar fora
document.addEventListener('click', (e) => {
  const menu = document.getElementById('menuDropdown');
  const icon = document.querySelector('.user-icon');
  
  if (menu && icon && !icon.contains(e.target) && !menu.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// Valida√ß√£o client-side
const addForm = document.getElementById('add-form');
if (addForm) {
  addForm.addEventListener('submit', function(e) {
    const ip = document.getElementById('ip')?.value;
    const domain = document.getElementById('domain')?.value;
    
    if (ip && !isValidIP(ip)) {
      e.preventDefault();
      showToast('IP inv√°lido. Use formato: 192.168.x.x, 10.x.x.x ou 172.16-31.x.x', 'danger');
      return;
    }
    
    if (domain && !isValidDomain(domain)) {
      e.preventDefault();
      showToast('Dom√≠nio inv√°lido. Use apenas letras, n√∫meros e h√≠fens.', 'danger');
      return;
    }
  });
}

// Fun√ß√µes de valida√ß√£o
function isValidIP(ip) {
  const pattern = /^(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3})$/;
  
  if (pattern.test(ip)) {
    const parts = ip.split('.');
    for (let part of parts) {
      const num = parseInt(part, 10);
      if (num < 0 || num > 255) {
        return false;
      }
    }
    return true;
  }
  return false;
}

function isValidDomain(domain) {
  const pattern = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
  return pattern.test(domain) && domain.length <= 253;
}

// Inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
  setupCopyButtons();
  
  // Se estiver em modo de edi√ß√£o, rolar para o formul√°rio de edi√ß√£o
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('edit')) {
    const editRow = document.querySelector('.card[style*="border: 2px solid #f59e0b"]');
    if (editRow) {
      editRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
});

// Ordenar registros por dom√≠nio base (agrupar dom√≠nios similares)
function sortByDomain(baseDomain) {
    const tbody = document.querySelector('tbody');
    const rows = Array.from(tbody.children).filter(row => !row.querySelector('.card[style*="border: 2px solid #f59e0b"]'));

    // Separar linhas em grupos: dom√≠nios com a mesma base primeiro, depois outros
    const matchingDomains = [];
    const others = [];

    rows.forEach(row => {
        const domain = row.getAttribute('data-domain');
        if (domain) {
            const domainBase = domain.split('_')[0];
            if (domainBase === baseDomain) {
                matchingDomains.push(row);
            } else {
                others.push(row);
            }
        }
    });

    // Reordenar removendo todas as linhas e adicionando novamente na ordem correta
    rows.forEach(row => tbody.removeChild(row));

    // Adicionar primeiro dom√≠nios similares
    matchingDomains.forEach(row => tbody.appendChild(row));

    // Depois os outros
    others.forEach(row => tbody.appendChild(row));

    // Scroll para o topo da tabela
    document.querySelector('.table-responsive').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Toast de confirma√ß√£o
    showToast(`Agrupado dom√≠nios similares a ${baseDomain}`, 'success');
}

// Ordenar registros por IP similar (agrupar IPs iguais ou similares)
function sortByIP(selectedIP) {
    const tbody = document.querySelector('tbody');
    const rows = Array.from(tbody.children).filter(row => !row.querySelector('.card[style*="border: 2px solid #f59e0b"]'));

    // Separar linhas em grupos: IPs iguais primeiro, depois similares, depois outros
    const exactMatches = [];
    const similarMatches = [];
    const others = [];

    rows.forEach(row => {
        const ip = row.getAttribute('data-ip');
        if (ip) {
            if (ip === selectedIP) {
                exactMatches.push(row);
            } else if (ip.split('.')[0] === selectedIP.split('.')[0] && ip.split('.')[1] === selectedIP.split('.')[1]) {
                // Mesmo subrede (192.168.5.x)
                similarMatches.push(row);
            } else {
                others.push(row);
            }
        }
    });

    // Reordenar removendo todas as linhas e adicionando novamente na ordem correta
    rows.forEach(row => tbody.removeChild(row));

    // Adicionar primeiro IPs exatos
    exactMatches.forEach(row => tbody.appendChild(row));

    // Depois IPs similares
    similarMatches.forEach(row => tbody.appendChild(row));

    // Depois os outros
    others.forEach(row => tbody.appendChild(row));

    // Scroll para o topo da tabela
    document.querySelector('.table-responsive').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Toast de confirma√ß√£o
    showToast(`Agrupado registros com IPs similares a ${selectedIP}`, 'success');
}
// Re-inicializar copia ap√≥s poss√≠veis atualiza√ß√µes din√¢micas do DOM
setTimeout(setupCopyButtons, 100);
</script>
{% endblock %}