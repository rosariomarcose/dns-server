{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="topbar">
    <h2>‚ö° Servidor DNS Local (Apenas Rede Interna)</h2>
    <div class="user-menu">
      <div class="user-icon" onclick="toggleMenu()">üë§</div>
      <div class="menu-dropdown" id="menuDropdown">
        {% if session.get('is_admin') %}
          <a href="/admin" class="menu-item">‚öôÔ∏è Configura√ß√µes</a>
        {% endif %}
        <form method="POST" action="/logout" style="margin:0;">
          <button type="submit" class="menu-item">üö™ Logout</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Form adicionar DNS -->
  <div class="card">
    <form method="post" action="/add" id="add-form">
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label for="ip" style="display: block; margin-bottom: 5px; font-weight: 500;">IP interno:</label>
          <input type="text" id="ip" name="ip" placeholder="ex: 192.168.5.10" required
                 pattern="^(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3})$">
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label for="domain" style="display: block; margin-bottom: 5px; font-weight: 500;">Dom√≠nio:</label>
          <input type="text" id="domain" name="domain" placeholder="ex: app.local" required
                 pattern="^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$">
        </div>
        <div style="align-self: flex-end;">
          <button type="submit" class="btn-primary">‚ûï Adicionar</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Registros DNS -->
  <div class="card">
    <h3>Registros Atuais ({{ records|length }})</h3>
    {% if records|length == 0 %}
      <p class="text-muted">Nenhum registro ainda. Adicione acima!</p>
    {% else %}
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Dom√≠nio</th>
              <th>IP</th>
              <th style="width: 220px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for domain, ip in records %}
            <tr>
              <td><strong>{{ domain }}</strong></td>
              <td><code class="code">{{ ip }}</code></td>
              <td class="actions">
                <button type="button" class="btn-success btn-sm btn-copy" data-ip="{{ ip }}" onclick="event.stopPropagation();">üìã Copiar IP</button>
                <a href="/edit/{{ domain }}">
                  <button class="btn-warning btn-sm" type="button" onclick="event.stopPropagation();">‚úèÔ∏è Editar</button>
                </a>
                <form method="post" action="/delete/{{ domain }}" style="display:inline;"
                  onsubmit="return confirm('‚ö†Ô∏è Tem certeza que quer remover\n{{ domain }} ‚Üí {{ ip }} ?');">
                  <button type="submit" class="btn-danger btn-sm" onclick="event.stopPropagation();">üóëÔ∏è Remover</button>
                </form>
              </td>
            </tr>

            {% if edit_domain == domain %}
            <tr>
              <td colspan="3">
                <div class="card" style="border: 2px solid #f59e0b; margin-top:10px;">
                  <h4>‚úèÔ∏è Editando: {{ edit_domain }}</h4>
                  <form method="post" action="/update/{{ edit_domain }}">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                      <div style="flex: 1; min-width: 200px;">
                        <label for="new_ip" style="display: block; margin-bottom: 5px; font-weight: 500;">Novo IP interno:</label>
                        <input type="text" id="new_ip" name="new_ip" value="{{ current_ip }}" required 
                               placeholder="Novo IP interno"
                               pattern="^(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3})$">
                      </div>
                      <div>
                        <button type="submit" class="btn-primary">üíæ Salvar</button>
                        <a href="/"><button type="button" class="btn-secondary">‚ùå Cancelar</button></a>
                      </div>
                    </div>
                  </form>
                </div>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Mostrar toast
function showToast(message, type = "success") {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast show';
  toast.textContent = message;

  switch(type) {
    case 'success': toast.style.background = 'var(--success)'; break;
    case 'danger': toast.style.background = 'var(--danger)'; break;
    case 'warning': toast.style.background = 'var(--warning)'; break;
    default: toast.style.background = 'var(--gray)';
  }

  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (container.contains(toast)) {
        container.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Flash messages do Flask - CORRIGIDO
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      showToast({{ msg|tojson }}, {{ category|tojson }});
    {% endfor %}
  {% endif %}
{% endwith %}

// Copiar IP - CORRIGIDO
function setupCopyButtons() {
  document.querySelectorAll('.btn-copy').forEach(btn => {
    // Remove event listeners existentes para evitar duplica√ß√£o
    btn.replaceWith(btn.cloneNode(true));
  });

  // Re-attach event listeners aos novos bot√µes
  document.querySelectorAll('.btn-copy').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const text = btn.getAttribute('data-ip');
      if (!text) return;

      try {
        // M√©todo moderno
        await navigator.clipboard.writeText(text);
        showToast('üìã IP copiado: ' + text, 'success');
      } catch (err) {
        // Fallback para navegadores antigos
        try {
          const temp = document.createElement('textarea');
          temp.value = text;
          temp.style.position = 'fixed';
          temp.style.opacity = '0';
          document.body.appendChild(temp);
          temp.select();
          const successful = document.execCommand('copy');
          document.body.removeChild(temp);
          
          if (successful) {
            showToast('üìã IP copiado: ' + text, 'success');
          } else {
            showToast('‚ùå Falha ao copiar IP', 'danger');
          }
        } catch (fallbackErr) {
          showToast('‚ùå Erro ao copiar IP', 'danger');
        }
      }
    });
  });
}

// Menu usu√°rio - CORRIGIDO
function toggleMenu() {
  const menu = document.getElementById('menuDropdown');
  if (menu) {
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }
}

// Fechar menu ao clicar fora - CORRIGIDO
document.addEventListener('click', (e) => {
  const menu = document.getElementById('menuDropdown');
  const icon = document.querySelector('.user-icon');
  
  if (menu && icon && !icon.contains(e.target) && !menu.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// Valida√ß√£o client-side - CORRIGIDO
const addForm = document.getElementById('add-form');
if (addForm) {
  addForm.addEventListener('submit', function(e) {
    const ip = document.getElementById('ip')?.value;
    const domain = document.getElementById('domain')?.value;
    
    if (ip && !isValidIP(ip)) {
      e.preventDefault();
      showToast('IP inv√°lido. Use formato: 192.168.x.x, 10.x.x.x ou 172.16-31.x.x', 'danger');
      return;
    }
    
    if (domain && !isValidDomain(domain)) {
      e.preventDefault();
      showToast('Dom√≠nio inv√°lido. Use apenas letras, n√∫meros e h√≠fens.', 'danger');
      return;
    }
  });
}

// Fun√ß√µes de valida√ß√£o - CORRIGIDAS
function isValidIP(ip) {
  // Padr√£o para IPs privados:
  // - 192.168.x.x
  // - 10.x.x.x  
  // - 172.16.x.x to 172.31.x.x
  const pattern = /^(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.\d{1,3}\.\d{1,3})$/;
  
  // Verifica tamb√©m cada octeto (0-255)
  if (pattern.test(ip)) {
    const parts = ip.split('.');
    for (let part of parts) {
      const num = parseInt(part, 10);
      if (num < 0 || num > 255) {
        return false;
      }
    }
    return true;
  }
  return false;
}

function isValidDomain(domain) {
  const pattern = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
  return pattern.test(domain) && domain.length <= 253;
}

// Inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
  setupCopyButtons();
  
  // Se estiver em modo de edi√ß√£o, rolar para o formul√°rio de edi√ß√£o
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('edit')) {
    const editRow = document.querySelector('.card[style*="border: 2px solid #f59e0b"]');
    if (editRow) {
      editRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
});

// Re-inicializar copia ap√≥s poss√≠veis atualiza√ß√µes din√¢micas do DOM
setTimeout(setupCopyButtons, 100);
</script>
{% endblock %}